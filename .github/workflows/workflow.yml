steps:
  - name: Checkout repository
    uses: actions/checkout@v4
    with:
      fetch-depth: 0

  - name: Set up Python
    uses: actions/setup-python@v4
    with:
      python-version: "3.10"

  - name: Show Python and mlflow versions (debug)
    run: |
      python --version
      pip --version

  - name: Check Env
    run: |
      echo "CSV_URL=$CSV_URL"
      echo "TARGET_VAR=$TARGET_VAR"

  - name: Install dependencies
    run: |
      set -e
      python -m pip install --upgrade pip
      pip install mlflow dagshub scikit-learn pandas numpy seaborn

  - name: Run MLflow Project
    env:
      DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
    run: |
      set -e
      # Run the project from the repo root (use '.' not the MLproject filename)
      mlflow run . --env-manager=local -P CSV_URL="$CSV_URL" -P TARGET_VAR="$TARGET_VAR"

  - name: Get latest MLflow run_id
    run: |
      set -e
      # Find the most recent run directory under mlruns/0
      RUN_DIR=$(ls -td mlruns/0/* 2>/dev/null | head -n1 || true)
      if [ -z "$RUN_DIR" ]; then
        echo "No MLflow run found in mlruns/0. Failing."
        ls -la mlruns || true
        exit 1
      fi
      RUN_ID=$(basename "$RUN_DIR")
      echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
      echo "Latest run_id: $RUN_ID"

  - name: Build Docker Model
    run: |
      set -e
      # Confirm the artifact path your MLflow run logged (here assumed "model")
      mlflow models build-docker \
        --model-uri "runs:/$RUN_ID/model" \
        --name "cc"

  - name: Log in to Docker Hub
    uses: docker/login-action@v2
    with:
      username: ${{ secrets.DOCKER_HUB_USERNAME }}
      password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

  - name: Tag Docker Image
    run: |
      docker tag cc ${{ secrets.DOCKER_HUB_USERNAME }}/cc:latest

  - name: Push Docker Image
    run: |
      set -e
      docker push ${{ secrets.DOCKER_HUB_USERNAME }}/cc:latest
